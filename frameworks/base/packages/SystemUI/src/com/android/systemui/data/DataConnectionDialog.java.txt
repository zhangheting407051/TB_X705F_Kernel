//yexumin@wind-mobi.com add for feature10956 start
package com.android.systemui.data;

import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.IntentFilter;


import android.net.NetworkInfo;
import android.net.wifi.WifiManager;

import android.os.Bundle;
import android.os.ServiceManager;

import android.provider.Settings;

import android.telephony.TelephonyManager;

import android.util.Log;

import android.view.View;
import android.widget.TextView;

import com.android.internal.app.AlertActivity;
import com.android.internal.app.AlertController;

import com.android.internal.telephony.ITelephony;
import com.android.systemui.R;


public class DataConnectionDialog extends AlertActivity implements
        DialogInterface.OnClickListener {
    private static final String ACTION_IPO_SHUTDOWN = "android.intent.action.ACTION_SHUTDOWN_IPO";
    private static final String ACTION_WIFI_STATE_CHANGED = WifiManager.NETWORK_STATE_CHANGED_ACTION;
    private static final String ACTION_SS_STATE_CHANGED = "android.intent.action.SERVICE_STATE";
    private ITelephony mService;

    private final BroadcastReceiver mReceiver = new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            String action = intent.getAction();
            Log.d("DataConnectionDialog", "onReceive : " + action);
            if (ACTION_IPO_SHUTDOWN.equals(action)) {
                Log.d("DataConnectionDialog", "onReceive : " + action);
                finish();
            } else if (ACTION_WIFI_STATE_CHANGED.equals(action)) {
                NetworkInfo info = (NetworkInfo) intent
                        .getParcelableExtra(WifiManager.EXTRA_NETWORK_INFO);

                if (info == null) {
                    finish();
                    return;
                }
                Log.d("DataConnectionDialog", "onReceive : " + action
                        + ", NetworkInfo: " + info);
                if (info.getState().equals(NetworkInfo.State.CONNECTED)) {
                    // restore DATA SWITCH
                    onUserJustOnce();
                    finish();
                }
            } else if (ACTION_SS_STATE_CHANGED.equals(action)) {
                Log.d("DataConnectionDialog", "onReceive : " + action);
                if (Settings.System.getInt(context.getContentResolver(),
                        Settings.Global.AIRPLANE_MODE_ON, 0) != 0) {
                    finish();
                }
            }
        }
    };

    private void onUserJustOnce() {
        Log.d("DataConnectionDialog", "onUserJustOnce");

        TelephonyManager telMgr = (TelephonyManager) getSystemService(Context.TELEPHONY_SERVICE);
        if (telMgr == null) {
            Log.d("DataConnectionDialog",
                    "onUserJustOnce : get TELEPHONY_SERVICE failed");
            return;
        }

        Log.d("DataConnectionDialog", "onUserJustOnce");
        telMgr.setDataEnabled(true);
    }

    private void onUserAlways() {
        Log.d("DataConnectionDialog", "onUserAlways");

        TelephonyManager telMgr = (TelephonyManager) getSystemService(Context.TELEPHONY_SERVICE);
        if (telMgr == null) {
            Log.d("DataConnectionDialog",
                    "onUserAlways : get TELEPHONY_SERVICE failed");
            return;
        }

        boolean result = android.provider.Settings.Global.putInt(this.getContentResolver(),
                Settings.Global.LENOVO_WIFI_SWITCH_ASK, 1);

        Log.d("DataConnectionDialog", "onUserAlways, result:" + result);
        telMgr.setDataEnabled(true);
    }

    private void onUserClose() {
        Log.d("DataConnectionDialog", "onUserClose");

        TelephonyManager telMgr = (TelephonyManager) getSystemService(Context.TELEPHONY_SERVICE);
        if (telMgr != null) {
            telMgr.setDataEnabled(false);
        }
    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        super.setFinishOnTouchOutside(false);

        // Set up the "dialog"
        final AlertController.AlertParams p = mAlertParams;
        p.mIconId = android.R.drawable.ic_dialog_alert;
        p.mTitle = getString(R.string.wind_wifi_switch_mobile_title);
        p.mNeutralButtonText = getString(R.string.wind_wifi_switch_mobile_once);
        p.mNeutralButtonListener = this;
        p.mNegativeButtonText = getString(R.string.wind_wifi_switch_mobile_always);
        p.mNegativeButtonListener = this;
        p.mPositiveButtonText = getString(R.string.wind_wifi_switch_mobile_close);
        p.mPositiveButtonListener = this;
        setupAlert();

        IntentFilter intentFilter = new IntentFilter();
        intentFilter.addAction(ACTION_IPO_SHUTDOWN);
        intentFilter.addAction(ACTION_WIFI_STATE_CHANGED);
        intentFilter.addAction(ACTION_SS_STATE_CHANGED);
        registerReceiver(mReceiver, intentFilter);

        mService = ITelephony.Stub.asInterface(ServiceManager
                .getService(Context.TELEPHONY_SERVICE));
    }

    @Override
    protected void onDestroy() {
        Log.d("DataConnectionDialog", "onDestroy");

        super.onDestroy();
        unregisterReceiver(mReceiver);
    }

    public void onClick(DialogInterface dialog, int which) {
        Log.d("DataConnectionDialog", "onClick which=" + which);

        switch (which) {
        case DialogInterface.BUTTON_NEUTRAL:
            onUserJustOnce();
            finish();
            break;

        case DialogInterface.BUTTON_NEGATIVE:
            onUserAlways();
            finish();
            break;

        case DialogInterface.BUTTON_POSITIVE:
            onUserClose();
            finish();
            break;

        default:
            Log.d("DataConnectionDialog", "onClick(): which=" + which);
            break;
        }
    }
}
//yexumin@wind-mobi.com add for feature10956 end
