/*
 * Copyright (C) 2012 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.android.gallery3d.filtershow.editors;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

import android.content.Context;
import android.os.Handler;
import android.view.LayoutInflater;
import android.view.MenuItem;
import android.view.View;
import android.view.ViewGroup;
import android.widget.FrameLayout;
import android.widget.LinearLayout;
import android.widget.PopupMenu;
import android.widget.SeekBar;
import android.widget.TextView;
import android.widget.Button;
import android.content.res.Configuration;
import android.util.Log;

import org.codeaurora.gallery.R;
import com.android.gallery3d.filtershow.FilterShowActivity;
import com.android.gallery3d.filtershow.controller.BasicParameterInt;
import com.android.gallery3d.filtershow.controller.Parameter;
import com.android.gallery3d.filtershow.filters.FilterVignetteRepresentation;
import com.android.gallery3d.filtershow.filters.FilterRepresentation;
import com.android.gallery3d.filtershow.imageshow.ImageVignette;


public class EditorVignette extends ParametricEditor {
    public static final int ID = R.id.vignetteEditor;
    private static final String LOGTAG = "EditorVignettePlanet";
    ImageVignette mImageVignette;

    private SeekBar mVignetteBar;
    private SeekBar mExposureBar;
    private SeekBar mSaturationBar;
    private SeekBar mContrastBar;
    private SeekBar mFalloffBar;


    private TextView mVignetteValue;
    private TextView mExposureValue;
    private TextView mSaturationValue;
    private TextView mContrastValue;
    private TextView mFalloffValue;

    private SwapButton mButton;
    private final Handler mHandler = new Handler();

    int[] mMenuStrings = {
            R.string.vignette_main,
            R.string.vignette_exposure,
            R.string.vignette_saturation,
            R.string.vignette_contrast,
            R.string.vignette_falloff,
    };

    String mCurrentlyEditing = null;
    //fix feature#10896 xiangkezhu@wind-mobi.com 20180319 begin
    private Button mVignetteButton;
    private Button mFalloffButton;
    private Button mContrastButton;
    private Button mSaturationButton;
    private Button mLastPressButton;
    private SeekBar mVignetteBars;
    private LinearLayout mControlLayout;
    private TextView mVignetteValues;
    private int mLastViewId = R.id.por_vignette_main;
    private Map<Integer, Integer> mSeekbarValueMap = new ConcurrentHashMap<Integer, Integer>();
    private static final int VIGNETTE_VALUE = 0;
    private static final int FALLOFF_VALUE = 4;
    private static final int CONTRAST_VALUE = 3;
    private static final int SATURATION_VALUE = 2;
    private int mTempValue = 0;
    //fix feature#10896 xiangkezhu@wind-mobi.com 20180319 end

    public EditorVignette() {
        super(ID, R.layout.filtershow_vignette_editor, R.id.imageVignette);
    }

    @Override
    public void createEditor(Context context, FrameLayout frameLayout) {
        super.createEditor(context, frameLayout);
        mImageVignette = (ImageVignette) mImageShow;
        mImageVignette.setEditor(this);
    }

    @Override
    public void reflectCurrentFilter() {
        if (useCompact(mContext)) {
            super.reflectCurrentFilter();

            FilterRepresentation rep = getLocalRepresentation();
            if (rep != null && getLocalRepresentation() instanceof FilterVignetteRepresentation) {
                FilterVignetteRepresentation drawRep = (FilterVignetteRepresentation) rep;
                mImageVignette.setRepresentation(drawRep);
            }
            updateText();
            return;
        }
        mLocalRepresentation = null;
        if (getLocalRepresentation() != null
                && getLocalRepresentation() instanceof FilterVignetteRepresentation) {
            FilterVignetteRepresentation rep =
                    (FilterVignetteRepresentation) getLocalRepresentation();
            int min;
            int []mode = {
                    FilterVignetteRepresentation.MODE_VIGNETTE,
                    FilterVignetteRepresentation.MODE_EXPOSURE,
                    FilterVignetteRepresentation.MODE_SATURATION,
                    FilterVignetteRepresentation.MODE_CONTRAST,
                    FilterVignetteRepresentation.MODE_FALLOFF
            };
            SeekBar []sliders = {
                    mVignetteBar,
                    mExposureBar,
                    mSaturationBar,
                    mContrastBar,
                    mFalloffBar
            };
            TextView []label = {
                    mVignetteValue,
                    mExposureValue,
                    mSaturationValue,
                    mContrastValue,
                    mFalloffValue
            };
            for (int i = 0; i < mode.length; i++) {
                BasicParameterInt p = (BasicParameterInt) rep.getFilterParameter(mode[i]);
                int value = p.getValue();
                sliders[i].setMax(p.getMaximum() - p.getMinimum());
                sliders[i].setProgress(value - p.getMinimum());
                label[i].setText("" + value);
            }

            mImageVignette.setRepresentation(rep);
            super.reflectCurrentFilter();
            updateText();
        }
    }



    @Override
    public String calculateUserMessage(Context context, String effectName, Object parameterValue) {
        FilterRepresentation rep = getLocalRepresentation();
        if (rep == null || !(rep instanceof FilterVignetteRepresentation)) {
            return "";
        }
        FilterVignetteRepresentation csrep = (FilterVignetteRepresentation) rep;
        int mode = csrep.getParameterMode();
        String paramString;

        paramString = mContext.getString(mMenuStrings[mode]);

        int val = csrep.getCurrentParameter();
        return paramString + ((val > 0) ? " +" : " ") + val;
    }

    @Override
    public void openUtilityPanel(final LinearLayout accessoryViewList) {
        mButton = (SwapButton) accessoryViewList.findViewById(R.id.applyEffect);
        mButton.setText(mContext.getString(R.string.vignette_main));

        if (useCompact(mContext)) {
            final PopupMenu popupMenu = new PopupMenu(mImageShow.getActivity(), mButton);

            popupMenu.getMenuInflater().inflate(R.menu.filtershow_menu_vignette,
                    popupMenu.getMenu());

            popupMenu.setOnMenuItemClickListener(new PopupMenu.OnMenuItemClickListener() {
                @Override
                public boolean onMenuItemClick(MenuItem item) {
                    selectMenuItem(item);
                    return true;
                }
            });
            mButton.setOnClickListener(new View.OnClickListener() {
                @Override
                public void onClick(View arg0) {
                    popupMenu.show();
                    ((FilterShowActivity)mContext).onShowMenu(popupMenu);
                }
            });
            mButton.setListener(this);

            FilterVignetteRepresentation csrep = getVignetteRep();
            String menuString = mContext.getString(mMenuStrings[0]);
            switchToMode(csrep, FilterVignetteRepresentation.MODE_VIGNETTE, menuString);
        } else {
            mButton.setText(mContext.getString(R.string.vignette_main));
        }
    }

    @Override
    public void setEditPanelUI(View editControl) {
       //fix feature#10896 xiangkezhu@wind-mobi.com 20180319 begin
       /* if (useCompact(mContext)) {
            super.setEditPanelUI(editControl);
            return;
        }*/
        mEditControl = editControl;
        //mEditTitle.setCompoundDrawables(null, null, null, null);
        LinearLayout group = (LinearLayout) editControl;
        LayoutInflater inflater =
                (LayoutInflater) mContext.getSystemService(Context.LAYOUT_INFLATER_SERVICE);
        mControlLayout = (LinearLayout) inflater.inflate(
                R.layout.filtershow_vignette_controls, group, false);
        ViewGroup.LayoutParams lp = new LinearLayout.LayoutParams(
                ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.MATCH_PARENT);
        mControlLayout.setLayoutParams(lp);
        group.removeAllViews();
        group.addView(mControlLayout);

        if (useCompact(mContext)) {
            initPorViews(mControlLayout);
        } else {
            initLandViews(mControlLayout);
        }
    }

    private void initPorViews(LinearLayout controls){
        mVignetteButton = (Button) controls.findViewById(R.id.por_vignette_main);
        mFalloffButton = (Button) controls.findViewById(R.id.por_vignette_falloff);
        mContrastButton = (Button) controls.findViewById(R.id.por_vignette_contrast);
        mSaturationButton = (Button) controls.findViewById(R.id.por_vignette_saturation);

        mVignetteButton.setOnClickListener(mOnClickListener);
        mFalloffButton.setOnClickListener(mOnClickListener);
        mContrastButton.setOnClickListener(mOnClickListener);
        mSaturationButton.setOnClickListener(mOnClickListener);

        mVignetteValues = (TextView)controls.findViewById(R.id.primaryValue);
        mVignetteBars = (SeekBar)controls.findViewById(R.id.primarySeekBar);
        mVignetteBars.setMax(200);
        resetSeekbarValues();
        FilterVignetteRepresentation rep = getVignetteRep();
        BasicParameterInt p = rep.getFilterParameter(rep.getParameterMode());
        mVignetteValues.setText(p.getDefaultValue() + "");

        mVignetteBars.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener() {

            @Override
            public void onStopTrackingTouch(SeekBar seekBar) {
            }

            @Override
            public void onStartTrackingTouch(SeekBar seekBar) {
            }

            @Override
            public void onProgressChanged(SeekBar seekBar, int progress, boolean fromUser) {
                FilterVignetteRepresentation rep = getVignetteRep();
                int value = progress;
                BasicParameterInt  p;
                p = rep.getFilterParameter(rep.getParameterMode());
                value += p.getMinimum();
                mVignetteValues.setText("" + value);
                rep.setCurrentParameter(value);
                commitLocalRepresentation();
                mTempValue = value;
            }
        });

        controls.findViewById(R.id.slider_cancel).setOnClickListener(new View.OnClickListener() {
               @Override
               public void onClick(View view) {
                   ((FilterShowActivity)mContext).cancelFilter();
                   resetSeekbarValues();
               }
           }
        );
        controls.findViewById(R.id.slider_save).setOnClickListener(new View.OnClickListener() {
                 @Override
                 public void onClick(View view) {
                     commitLocalRepresentation();
                     ((FilterShowActivity)mContext).applyFilter(EditorVignette.this);
                     resetSeekbarValues();
                 }
             }
        );
    }

    private void initLandViews(LinearLayout controls) {
        mVignetteBar = (SeekBar) controls.findViewById(R.id.mainVignetteSeekbar);
        mVignetteBar.setMax(200);
        mVignetteBar.setOnSeekBarChangeListener(this);
        mVignetteValue = (TextView) controls.findViewById(R.id.mainVignetteValue);
        mExposureBar = (SeekBar) controls.findViewById(R.id.exposureSeekBar);
        mExposureBar.setMax(200);
        mExposureBar.setOnSeekBarChangeListener(this);
        mExposureValue = (TextView) controls.findViewById(R.id.exposureValue);
        mSaturationBar = (SeekBar) controls.findViewById(R.id.saturationSeekBar);
        mSaturationBar.setMax(200);
        mSaturationBar.setOnSeekBarChangeListener(this);
        mSaturationValue = (TextView) controls.findViewById(R.id.saturationValue);
        mContrastBar = (SeekBar) controls.findViewById(R.id.contrastSeekBar);
        mContrastBar.setMax(200);
        mContrastBar.setOnSeekBarChangeListener(this);
        mContrastValue = (TextView) controls.findViewById(R.id.contrastValue);
        mFalloffBar = (SeekBar) controls.findViewById(R.id.falloffSeekBar);
        mFalloffBar.setMax(200);
        mFalloffBar.setOnSeekBarChangeListener(this);
        mFalloffValue = (TextView) controls.findViewById(R.id.falloffValue);
    }

    private View.OnClickListener mOnClickListener = new View.OnClickListener() {
        @Override
        public void onClick(View view) {
            FilterVignetteRepresentation rep = getVignetteRep();
            int progress = 0;
            int viewId = view.getId();
            Log.e(LOGTAG,"OnClick: viewId = " + viewId + ",mLastViewId = " + mLastViewId);
            if (mLastViewId != viewId) {
                mLastPressButton = (Button)mControlLayout.findViewById(mLastViewId);
                setButtonOrginal(mLastPressButton);
            }
            //fix feature#10896 xiangkezhu@wind-mobi.com 2018/4/4 begin
            if(viewId != R.id.por_vignette_main){
                setButtonOrginal(mVignetteButton);
            }
            //fix feature#10896 xiangkezhu@wind-mobi.com 2018/4/4 end
            switch (viewId){
                case R.id.por_vignette_main: {
                    mVignetteButton.setBackground(mContext.getResources().getDrawable(R.drawable.button_selected));
                    rep.setParameterMode(FilterVignetteRepresentation.MODE_VIGNETTE);
                    progress = mSeekbarValueMap.get(VIGNETTE_VALUE);
                    break;
                }
                case R.id.por_vignette_falloff: {
                    mFalloffButton.setBackground(mContext.getResources().getDrawable(R.drawable.button_selected));
                    rep.setParameterMode(FilterVignetteRepresentation.MODE_FALLOFF);
                    progress = mSeekbarValueMap.get(FALLOFF_VALUE);
                    break;
                }
                case R.id.por_vignette_contrast: {
                    mContrastButton.setBackground(mContext.getResources().getDrawable(R.drawable.button_selected));
                    rep.setParameterMode(FilterVignetteRepresentation.MODE_CONTRAST);
                    progress = mSeekbarValueMap.get(CONTRAST_VALUE);
                    break;
                }
                case R.id.por_vignette_saturation: {
                    mSaturationButton.setBackground(mContext.getResources().getDrawable(R.drawable.button_selected));
                    rep.setParameterMode(FilterVignetteRepresentation.MODE_SATURATION);
                    progress = mSeekbarValueMap.get(SATURATION_VALUE);
                    break;
                }
            }
            updateSeekbarValues(mTempValue, mLastViewId);
            mVignetteBars.setProgress(progress + 100);
            mVignetteValues.setText(progress + "");
            mLastViewId = viewId;
        }
    };


    private void resetSeekbarValues() {
        mSeekbarValueMap.put(VIGNETTE_VALUE, 0);
        mSeekbarValueMap.put(FALLOFF_VALUE, 0);
        mSeekbarValueMap.put(CONTRAST_VALUE, 0);
        mSeekbarValueMap.put(SATURATION_VALUE, 0);
    }

    private void updateSeekbarValues(int progress, int lastViewId) {
        switch (lastViewId) {
        case R.id.por_vignette_main:
            mSeekbarValueMap.put(VIGNETTE_VALUE, progress);
            break;
        case R.id.por_vignette_falloff:
            mSeekbarValueMap.put(FALLOFF_VALUE, progress);
            break;
        case R.id.por_vignette_contrast:
            mSeekbarValueMap.put(CONTRAST_VALUE, progress);
            break;
        case R.id.por_vignette_saturation:
            mSeekbarValueMap.put(SATURATION_VALUE, progress);
            break;
        default:
            break;
        }
    }

    private void setButtonOrginal(Button button){
        button.setBackground(mContext.getResources().getDrawable(R.drawable.button_original));
    }
    //fix feature#10896 xiangkezhu@wind-mobi.com 20180319 end

    public int getParameterIndex(int id) {
        switch (id) {
            case R.id.editor_vignette_main:
                return FilterVignetteRepresentation.MODE_VIGNETTE;
            case R.id.editor_vignette_saturation:
                return FilterVignetteRepresentation.MODE_SATURATION;
            case R.id.editor_vignette_contrast:
                return FilterVignetteRepresentation.MODE_CONTRAST;
            case R.id.editor_vignette_exposure:
                return FilterVignetteRepresentation.MODE_EXPOSURE;
            case R.id.editor_vignette_falloff:
                return FilterVignetteRepresentation.MODE_FALLOFF;
        }
        return -1;
    }

    @Override
    public void detach() {
        if (mButton == null) {
            return;
        }
        mButton.setListener(null);
        mButton.setOnClickListener(null);
    }

    private void updateSeekBar(FilterVignetteRepresentation rep) {
        mControl.updateUI();
    }

    @Override
    protected Parameter getParameterToEdit(FilterRepresentation rep) {
        if (rep instanceof FilterVignetteRepresentation) {
            FilterVignetteRepresentation csrep = (FilterVignetteRepresentation) rep;
            Parameter param = csrep.getFilterParameter(csrep.getParameterMode());

            return param;
        }
        return null;
    }

    private FilterVignetteRepresentation getVignetteRep() {
        FilterRepresentation rep = getLocalRepresentation();
        if (rep != null
                && rep instanceof FilterVignetteRepresentation) {
            FilterVignetteRepresentation csrep = (FilterVignetteRepresentation) rep;
            return csrep;
        }
        return null;
    }

    protected void selectMenuItem(MenuItem item) {
        if (getLocalRepresentation() != null
                && getLocalRepresentation() instanceof FilterVignetteRepresentation) {
            FilterVignetteRepresentation csrep =
                    (FilterVignetteRepresentation) getLocalRepresentation();

            switchToMode(csrep, getParameterIndex(item.getItemId()), item.getTitle().toString());
        }
    }

    protected void switchToMode(FilterVignetteRepresentation csrep, int mode, String title) {
        if (csrep == null) {
            return;
        }
        csrep.setParameterMode(mode);
        mCurrentlyEditing = title;
        mButton.setText(mCurrentlyEditing);
        {
            Parameter param = getParameterToEdit(csrep);

            control(param, mEditControl);
        }
        updateSeekBar(csrep);
        mView.invalidate();
    }

    @Override
    public void onProgressChanged(SeekBar sbar, int progress, boolean arg2) {
        FilterVignetteRepresentation rep = getVignetteRep();
        int value = progress;
        BasicParameterInt  p;
        switch (sbar.getId()) {
            case R.id.mainVignetteSeekbar:
                rep.setParameterMode(FilterVignetteRepresentation.MODE_VIGNETTE);
                p = rep.getFilterParameter(rep.getParameterMode());
                value += p.getMinimum();
                mVignetteValue.setText("" + value);
                break;
            case R.id.exposureSeekBar:
                rep.setParameterMode(FilterVignetteRepresentation.MODE_EXPOSURE);
                p = rep.getFilterParameter(rep.getParameterMode());
                value += p.getMinimum();
                mExposureValue.setText("" + value);
                break;
            case R.id.saturationSeekBar:
                rep.setParameterMode(FilterVignetteRepresentation.MODE_SATURATION);
                p = rep.getFilterParameter(rep.getParameterMode());
                value += p.getMinimum();
                mSaturationValue.setText("" + value);
                break;
            case R.id.contrastSeekBar:
                rep.setParameterMode(FilterVignetteRepresentation.MODE_CONTRAST);
                p = rep.getFilterParameter(rep.getParameterMode());
                value += p.getMinimum();
                mContrastValue.setText("" + value);
                break;
            case R.id.falloffSeekBar:
                rep.setParameterMode(FilterVignetteRepresentation.MODE_FALLOFF);
                p = rep.getFilterParameter(rep.getParameterMode());
                value += p.getMinimum();
                mFalloffValue.setText("" + value);
                break;
        }
        rep.setCurrentParameter(value);
        commitLocalRepresentation();
    }

    @Override
    public void swapLeft(MenuItem item) {
        super.swapLeft(item);
        mButton.setTranslationX(0);
        mButton.animate().translationX(mButton.getWidth()).setDuration(SwapButton.ANIM_DURATION);
        Runnable updateButton = new Runnable() {
            @Override
            public void run() {
                mButton.animate().cancel();
                mButton.setTranslationX(0);
            }
        };
        mHandler.postDelayed(updateButton, SwapButton.ANIM_DURATION);
        selectMenuItem(item);
    }

    @Override
    public void swapRight(MenuItem item) {
        super.swapRight(item);
        mButton.setTranslationX(0);
        mButton.animate().translationX(-mButton.getWidth()).setDuration(SwapButton.ANIM_DURATION);
        Runnable updateButton = new Runnable() {
            @Override
            public void run() {
                mButton.animate().cancel();
                mButton.setTranslationX(0);
            }
        };
        mHandler.postDelayed(updateButton, SwapButton.ANIM_DURATION);
        selectMenuItem(item);
    }
    //fix feature#10896 xiangkezhu@wind-mobi.com 20180319 begin
    @Override
    public boolean showsActionBar() {
        if (useCompact(mContext)) {
            return false;
        } else {
            return true;
        }
    }
    //fix feature#10896 xiangkezhu@wind-mobi.com 20180319 end

}
